# CMS API stack â€“ same project as frontend so all appear under "wanaid"; main container "cms-api"
name: wanaid

services:
  cms-api:
    build:
      context: ../..
      dockerfile: docker/cms-api/Dockerfile.dev
    container_name: cms-api
    ports:
      - "${CMS_API_PORT:-9332}:8000"
    environment:
      APP_NAME: cms-api
      APP_ENV: local
      APP_TIMEZONE: Europe/London
      APP_DEBUG: "true"
      APP_URL: http://localhost:${CMS_API_PORT:-9332}
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-cms_api}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-secret}
      MAIL_MAILER: smtp
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_USERNAME: null
      MAIL_PASSWORD: null
      MAIL_FROM_ADDRESS: "cms-api@localhost"
      MAIL_FROM_NAME: "cms-api"
      SESSION_DRIVER: database
      CACHE_STORE: database
      QUEUE_CONNECTION: database
    volumes:
      - ../../backend/cms-api:/app
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  mysql:
    image: mysql:8.4
    container_name: cms-api-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_DATABASE: ${DB_DATABASE:-cms_api}
    volumes:
      - cms-api-mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "sh", "-c", "mysqladmin ping -h localhost -uroot -p$$MYSQL_ROOT_PASSWORD"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: cms-api-phpmyadmin
    environment:
      PMA_HOST: mysql
      PMA_USER: root
      PMA_PASSWORD: ${DB_PASSWORD:-secret}
    ports:
      - "${PHPMYADMIN_PORT:-8080}:80"
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  mailpit:
    image: axllent/mailpit:latest
    container_name: cms-api-mailpit
    ports:
      - "8025:8025"
      - "1025:1025"
    restart: unless-stopped

volumes:
  cms-api-mysql-data:
